<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Manage Apps - PWNboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css">
    <style>.mono{font-family:Menlo,monospace}</style>
</head>
<body class="p-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Manage Apps</h1>
            <a class="btn btn-secondary" href="{{ url_for('index') }}">Back to Dashboard</a>
        </div>

        <!-- Ephemeral token box (appears inline under the title after creation) -->
        <div id="ephemeral-token-box" style="display:none;" class="mb-3">
            <div class="alert alert-info" role="alert">
                <div class="d-flex justify-content-between align-items-start">
                    <div style="flex:1">
                        <strong>New token</strong>
                        <div id="ephemeral-token-value" class="mono bg-light p-2 mt-2" style="word-break:break-all;"></div>
                    </div>
                    <div class="ml-3 text-right">
                        <button id="ephemeral-copy" class="btn btn-sm btn-outline-primary mb-2">Copy</button>
                        <br>
                        <button id="ephemeral-close" class="btn btn-sm btn-link text-muted">âœ•</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Access Tokens</div>
            <div class="card-body">
                <div class="mb-3 d-flex align-items-center">
                    <button id="btn-add-token" class="btn btn-success mr-3" type="button">+ Add Token</button>
                    <small class="form-text text-muted">Created tokens are shown once. Keep them secure.</small>
                </div>

                <div id="tokens-loading" class="text-muted">Loading tokens...</div>
                <table class="table table-sm table-striped" id="tokens-table" style="display:none">
                    <thead>
                        <tr><th>Name</th><th>Token</th><th>App</th><th>Created</th><th>Expires</th><th>Actions</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="no-tokens" class="text-muted" style="display:none">No tokens found.</div>
            </div>
        </div>

    </div>

    <!-- Modal to create a token and display newly created token (shown once) -->
    <div class="modal fade" id="tokenModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Create Token</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button></div>
                <div class="modal-body">
                    <form id="modal-create-form">
                        <div class="form-group">
                            <label for="modal_token_name">Token name</label>
                            <input id="modal_token_name" name="token_name" class="form-control" placeholder="eg. deploy-key" required>
                        </div>
                        <div class="form-group">
                            <label for="modal_application">Application</label>
                            <input id="modal_application" name="application" class="form-control" placeholder="Application" required>
                        </div>
                        <div class="form-group">
                            <label for="modal_description">Description</label>
                            <input id="modal_description" name="description" class="form-control" placeholder="Optional description">
                        </div>
                        <div class="form-group">
                            <label for="modal_expiry">Expiry</label>
                            <select id="modal_expiry" name="expiry" class="form-control">
                                <option value="0">No expiry</option>
                                <option value="7d" selected>7 days</option>
                                <option value="30d">30 days</option>
                                <option value="90d">90 days</option>
                                <option value="1y">1 year</option>
                            </select>
                        </div>
                        <div id="create-feedback" class="text-muted small mb-2"></div>
                    </form>
                    <p class="text-muted mt-2">This token will be shown only once after creation. Copy it from the ephemeral box at the top of the screen.</p>
                </div>
                <div class="modal-footer">
                    <button id="submit-create-token" class="btn btn-primary">Create Token</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script>
    (function(){
        const table = document.querySelector('#tokens-table');
        const tbody = table.querySelector('tbody');
        const loading = document.getElementById('tokens-loading');
        const noTokens = document.getElementById('no-tokens');

        function fmt(ts){ if(!ts) return ''; return new Date(ts*1000).toLocaleString(); }

        async function load(){
            loading.style.display='';
            try{
                const res = await fetch('/tokens');
                if(!res.ok) throw new Error('no endpoint');
                // only attempt to parse JSON responses
                const ct = (res.headers.get('content-type')||'');
                let data = [];
                if(ct.indexOf('application/json') !== -1){
                    try{ data = await res.json(); }catch(e){ throw new Error('invalid json'); }
                } else {
                    throw new Error('unexpected content-type');
                }
                tbody.innerHTML='';
                if(!data.length){ table.style.display='none'; noTokens.style.display=''; }
                else{
                    noTokens.style.display='none'; table.style.display='';
                    data.forEach(t=>{
                        const tr = document.createElement('tr');
                        // show token name and first 3 chars only, with centered dots
                        const dot = '\u00B7';
                        const tokenPreview = (t.prefix ? t.prefix : (t.token ? t.token.slice(0,3) : '')) + dot.repeat(8);
                        tr.innerHTML = `<td>${t.token_name||''}</td><td class="mono">${tokenPreview}</td><td>${t.application||''}</td><td>${fmt(t.created)}</td><td>${fmt(t.expires)}</td><td><button class="btn btn-sm btn-danger btn-delete" data-hash="${t.hash}">Delete</button></td>`;
                        tbody.appendChild(tr);
                    })
                }
            }catch(e){ console.warn(e); loading.textContent='Token endpoints not available.' }
            finally{ loading.style.display='none' }
        }

        // open modal via Add Token button
        document.getElementById('btn-add-token').addEventListener('click', function(){
            document.getElementById('modal-create-form').reset();
            // clear any previous ephemeral token and feedback
            const eph = document.getElementById('ephemeral-token-box'); if (eph) { eph.style.display='none'; }
            const ev = document.getElementById('ephemeral-token-value'); if (ev) { ev.textContent=''; }
            const fb = document.getElementById('create-feedback'); if (fb) { fb.textContent=''; }
            $('#tokenModal').modal('show');
        });

        // handle create from modal and parse JSON safely
        document.getElementById('submit-create-token').addEventListener('click', async function(ev){
            const form = document.getElementById('modal-create-form');
            const btn = this; btn.disabled = true; btn.textContent = 'Creating...';
            try{
                const body = new URLSearchParams(new FormData(form));
                const res = await fetch('/tokens/create', { method:'POST', body });
                const ct = (res.headers.get('content-type')||'');
                let tokenText = '';
                if(ct.indexOf('application/json') !== -1){
                    try{ const json = await res.json(); tokenText = json && json.token ? json.token : ''; }catch(e){ tokenText = ''; }
                } else {
                    try{ tokenText = await res.text(); }catch(e){ tokenText = ''; }
                }

                if(!res.ok || !tokenText){
                    const msg = tokenText || 'Create failed';
                    document.getElementById('create-feedback').textContent = msg;
                } else {
                    // show ephemeral box and copy controls, then close modal
                    document.getElementById('ephemeral-token-value').textContent = tokenText;
                    document.getElementById('ephemeral-token-box').style.display = '';
                    $('#tokenModal').modal('hide');
                    document.getElementById('create-feedback').textContent = 'Token created.';
                }
                await load();
            }catch(e){ document.getElementById('create-feedback').textContent = 'Request failed'; }
            finally{ btn.disabled = false; btn.textContent = 'Create Token'; }
        });

        document.body.addEventListener('click', async function(ev){
            if(ev.target.classList.contains('btn-delete')){
                const h = ev.target.getAttribute('data-hash');
                if(!confirm('Delete token?')) return;
                try{
                    const res = await fetch('/tokens/'+encodeURIComponent(h), { method: 'DELETE' });
                    if(res.ok) await load(); else alert('Delete failed');
                }catch(e){ alert('Delete failed'); }
            }
        });

        

        // ephemeral box controls: copy and close
        document.getElementById('ephemeral-copy').addEventListener('click', async function(){
            const token = document.getElementById('ephemeral-token-value').textContent;
            if (!token) return;
            try{ await navigator.clipboard.writeText(token); this.textContent = 'Copied'; setTimeout(()=>{ this.textContent = 'Copy'; },2000);}catch(e){
                try{ const ta = document.createElement('textarea'); ta.value = token; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); this.textContent = 'Copied'; setTimeout(()=>{ this.textContent = 'Copy'; },2000);}catch(err){ alert('Copy failed'); }
            }
        });

        document.getElementById('ephemeral-close').addEventListener('click', function(){
            document.getElementById('ephemeral-token-box').style.display = 'none';
            document.getElementById('ephemeral-token-value').textContent = '';
        });

    
        load();
    })();
    </script>
</body>
</html>
