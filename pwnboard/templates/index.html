<html>
    <head>
        <title>PWNboard</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <link href='https://fonts.googleapis.com/css?family=Titillium+Web:600,400' rel='stylesheet' type='text/css' />
        <link href='https://fonts.googleapis.com/css?family=Jura:400,600' rel='stylesheet' type='text/css' />
        <link rel='stylesheet' href='/static/pwnboard.css' type='text/css' />
        <!-- Auto-refresh is handled via JS to avoid reloading while a modal is open -->
    </head>
    <body>
        <div class="container text-center">
{% if error %}
        <p id="error" class="alert alert-danger">{{ error }}</p>
{% endif %}
{% block content %}
{% endblock %}
            <h1 class="title" style="font-family: 'Jura';">PWNboard</h1>
        </div>
            <div class="" style="width:100%">
                <table class="table table-dark table-bordered">
                    <tr>
                        <thead>
                            <td>Hosts</td>
                        {% for team in teams %}
                            <td>Team {{ team }}</td>
                        {% endfor %}
                        </thead>
                    </tr>
                    {% for row in board %}
                    <tr>
                        <td><b>{{ row['name'] }}</b></td>
                        {% for host in row['hosts'] %}
                            {% set cb = host.get('Callbacks', 0) %}
                            {% if cb <= 2 %}
                                {% set color_class = 'bg-red-1' %}
                            {% elif cb <= 4 %}
                                {% set color_class = 'bg-red-2' %}
                            {% elif cb <= 6 %}
                                {% set color_class = 'bg-red-3' %}
                            {% elif cb <= 8 %}
                                {% set color_class = 'bg-red-4' %}
                            {% else %}
                                {% set color_class = 'bg-red-5' %}
                            {% endif %}
                            {% if 'online' in host and host['online'] != '' and host['online'] %}
                                <td class="{{ color_class }}">
                            {% elif 'creds_online' in host and host['creds_online'] != '' and host['creds_online'] %}
                                {% if theme == "blue" %}
                                    <td class="bg-warning">
                                {% else %}
                                    <td class="bg-warning">
                                {% endif %}
                            {% else %}
                                {% if theme == "blue" %}
                                    <td class="bg-primary">
                                {% else %}
                                    <td class="bg-danger">
                                {% endif %}
                            {% endif %}
                            {% set _ = host.pop('online', None) %}
                            {% set _ = host.pop('creds_online', None) %}
                            {% set ip = host.pop('ip') %}
                            <a href="#" class="text-white" style="color:inherit; text-decoration:none;" data-toggle="modal" data-target="#credsModal_{{ ip|replace('.', '_')|replace(':', '_') }}"><b>{{ ip }}</b></a><br/>

                            <!-- Credentials modal for this host -->
                            <div class="modal fade" id="credsModal_{{ ip|replace('.', '_')|replace(':', '_') }}" tabindex="-1" role="dialog" aria-labelledby="credsModalLabel_{{ ip|replace('.', '_')|replace(':', '_') }}">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content text-dark">
                                        <div class="modal-header">
                                            <h5 class="modal-title w-100 text-center" id="credsModalLabel_{{ ip|replace('.', '_')|replace(':', '_') }}">Credentials for {{ ip }}</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                        </div>
                                        <div class="modal-body text-left">
                                            {% set creds_list = host.pop('all_valid_creds', []) %}
                                            {% if creds_list and creds_list|length > 0 %}
                                                <ul class="list-unstyled">
                                                {% for cred in creds_list %}
                                                    <li><code>{{ cred }}</code></li>
                                                {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p>No credentials for host</p>
                                            {% endif %}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% for k, v in host.items() %}
                            <span style="font-size: 0.8em; display: inline-block;">
                                {# If we are on the last seen key, add 'm' #}
                                {{k}}: {{v}}
                            </span><br>
                            {% endfor %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </table>
            </div>
            <!-- Auto-refresh & modal persistence script -->
            <script>
            (function(){
                var reloadMs = 10000; // 10s

                // Periodically reload only if no modal is currently shown
                setInterval(function(){
                    try{
                        if (document.querySelectorAll('.modal.show').length === 0) {
                            window.location.reload();
                        }
                    } catch(e) { /* ignore */ }
                }, reloadMs);

                // Track which modal is open using sessionStorage so we can re-open after a refresh
                $(document).on('show.bs.modal', '.modal', function(){
                    try { sessionStorage.setItem('open_modal', this.id); } catch(e){}
                });

                $(document).on('hide.bs.modal', '.modal', function(){
                    try { sessionStorage.removeItem('open_modal'); } catch(e){}
                });

                // On load, reopen any modal that was open before refresh
                $(document).ready(function(){
                    try{
                        var id = sessionStorage.getItem('open_modal');
                        if (id) {
                            var el = document.getElementById(id);
                            if (el) {
                                $('#' + id).modal('show');
                            } else {
                                sessionStorage.removeItem('open_modal');
                            }
                        }
                    } catch(e) { /* ignore */ }
                });
            })();
            </script>
    </body>
</html>
